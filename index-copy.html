<!doctype html>

<script src="math.js" type = "text/javascript"></script>
<script src="handlers.js" type = "text/javascript"></script>
<script src="classes.js" type = "text/javascript"></script> 
<script src="redraw.js" type = "text/javascript"></script>
<script src="clickListeners.js" type = "text/javascript"></script>
<script src="selectListeners.js" type="text/javascript"></script>
<script src="operateListeners.js" type="text/javascript"></script>

<script type="text/javascript">
var thresh = 20; //Beneath this threshold points will snap to earlier points on a grid
</script>
<script src="http://s.codepen.io/assets/libs/modernizr.js" type="text/javascript"></script>

<script>
//Global collection of selected items
var selectedCollection = new Collection();

var mouseX = 0;
var mouseY = 0;

//TODO: make into local variables

var anchorMouseX = -1;
var anchorMouseY = -1;

var anchorMouseX2 = -1;
var anchorMouseY2 = -1;

//Stack to enable undos
//When you undo, pop something off the undo stack and onto the redo stack
//When you redo, pop something off the redo stack and onto the undo stack
//These have to have some sort of maximum size or it will probably fail but scalability is for a later version of me :)

var undoStack = new Array();
var redoStack = new Array();
</script>

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" type="text/css" href="main.css">
        

		<title>ProtoFluidics</title>
	</head>
    
	<body onload="redraw()">
    <div id="top">
	    
	    <h4> </h4>
	    <br>
        
<!-- Buttons -->
        
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<div id="drawing">
<img src="images/whitelogotext.jpg" style="width:130px;height:51px;">
    <button class="button" onclick="Upgrade"> Upgrade </button>
 <button class="button" onclick="download_handler()"> Save as JSON </button>
    
    <button class="button" onclick="upload_handler()">Upload JSON File </button>
    
    <button class="button" onclick="pillar_handler()">Pillar</button>

    
    <button class="button" onclick="helical_mixer()">Mixer</button>

    
    <button class="button" onclick="channel_handler()">Channel</button>
    
    <button class="button" onclick="collection_region_handler()">Collection Region</button>

    <button class="button" onClick="rect_region_handler()">Rectangular Region </button>
    
    <button class="button" onclick="move_handler()"><img src="images/move.png" width="20" height="20"></button>
    
    <button class="button" onclick="box_select_handler()"><img src="images/boxselect.svg" width="20" height="20"></button>
    
    <button class="button" onclick="pointer_select_handler()"><img src="images/mousepointer.png" width="20" height="20"> </button>
        
    
    <button class="button" onclick="redo_handler()"><img src="images/redoarrow.svg" width="20" height="20"> </button>	
        
    
    <button class="button" onclick="undo_handler()"><img src="images/undoarrow.svg" width="20" height="20"> </button>
    
<button class="button" onclick="new_handler()"><img src="images/newfile.svg" width="20" height="20"> </button>
        </div>
        </div>
	   <!-- <button class="button" onclick="t_junction()">T Junction</button>
        
	    <button class="button" onclick="cross_junction()">Cross Junction</button>-->
	    
<script>
    $(document).ready(function() {
  $("#drawing button").click(function(e) {
    var isActive = $(this).hasClass('active');
    $('.active').removeClass('active');
    if (!isActive) {
      $(this).addClass('active');
    }
  });
});
        </script>

<!-- End Buttons -->
        
<!-- Permanent Divs on Left -->
    <div id="leftperm">
<script src="SliderFancy/js/index.js"></script>

    <p2>Grid Size (microns)</p2>

<form>
  <input  for="amount" oninput="amount.value=rangeInput.value" 
       id="grid_size_slider" type="range" min="0" max="2000" step="100" name="rangeInput" />
    <input oninput="rangeInput.value=amount.value" 
   id="grid_size_slider_box" type="text" value="1000" name="amount" 
   for="rangeInput"  oninput="rangeInput.value=amount.value" />
    </form> 
</div>

<!-- End Permanent Divs on Left -->
<!-- Start Side Bar -->
<div id="left">
 <!-- Start Slider Bars -->
<br>
    <div id="sliders">
        
<div id="collection_sliders">
    <p2>Collection Region Size</p2>
<form>
  <input  for="amount" oninput="amount.value=rangeInput.value" 
       id="collection_region_size_slider" type="range" min="0" max="100" name="rangeInput" />

  <input oninput="rangeInput.value=amount.value" 
   id="collection_region_size_box" type="text" value="50" name="amount" 
   for="rangeInput"  oninput="rangeInput.value=amount.value" />

  </form>
</div>

<div id="channel_sliders">
    <p2>Channel Width</p2>
<form>
  <input  for="amount" oninput="amount.value=rangeInput.value" 
       id="channel_width_slider" type="range" min="0" max="50" name="rangeInput" />

  <input oninput="rangeInput.value=amount.value" 
   id="channel_width_box" type="text" value="25" name="amount" 
   for="rangeInput"  oninput="rangeInput.value=amount.value" />

  </form>
</div>
        
<div id="mixer_sliders">

    <p2>Mixer Wavelength</p2>
<form id="amount">
  <input  for="amount" oninput="amount.value=rangeInput.value" 
       id="mixer_wavelength_slider" type="range" min="0" max="10" name="rangeInput" />

  <input oninput="rangeInput.value=amount.value" 
   id="mixer_wavelength_box" type="text" value="5" name="amount" 
   for="rangeInput"  oninput="rangeInput.value=amount.value" />
  </form>

 <p2>Mixer Amplitude</p2>
<form id="amount">
  <input  for="amount" oninput="amount.value=rangeInput.value" 
       id="mixer_amplitude_slider" type="range" min="10" max="100" name="rangeInput" />

  <input oninput="rangeInput.value=amount.value" 
   id="mixer_amplitude_box" type="text" value="5" name="amount" 
   for="rangeInput"  oninput="rangeInput.value=amount.value" />

  </form>


    <p2>Mixer Width</p2>
<form id="amount">
  <input  for="amount" oninput="amount.value=rangeInput.value" 
       id="mixer_width_slider" type="range" min="0" max="50" name="rangeInput" />

  <input oninput="rangeInput.value=amount.value" 
   id="mixer_width_box" type="text" value="25" name="amount" 
   for="rangeInput"  oninput="rangeInput.value=amount.value" />

  </form>

</div>

<div id="pillar_sliders">

    <p2>Pillar Width</p2>
<form>
  <input  for="amount" oninput="amount.value=rangeInput.value" 
       id="pillar_width_slider" type="range" min="0" max="10" name="rangeInput" />

  <input oninput="rangeInput.value=amount.value" 
   id="pillar_width_box" type="text" value="5" name="amount" 
   for="rangeInput"  oninput="rangeInput.value=amount.value" />

  </form>
</div>
</div> 
        
<!-- End Slider Bars -->
        </div>


<!-- End Side Bar -->

<!-- Start Canvas -->

	    <div id="canvasDiv"> 
        </div>
    </body>
    
</html>
<script>

	// CREATE CANVAS //

	var canvasDiv = document.getElementById('canvasDiv');
	canvas = document.createElement('canvas');
	canvas.setAttribute('width', 800);
	canvas.setAttribute('height', 700);
	canvas.setAttribute('id', 'canvas');
	canvasDiv.appendChild(canvas);
	if(typeof G_vmlCanvasManager != 'undefined') {
		canvas = G_vmlCanvasManager.initElement(canvas);
	}
	context = canvas.getContext("2d");


	// ENABLING FILE INPUT

	var upload = document.createElement("INPUT"); //creates an input button
	upload.setAttribute("id", "fileInput");
	upload.setAttribute("type", "file");
	upload.addEventListener("change", handleFiles, false);
	var left = document.getElementById("left");
	left.appendChild(upload);
	upload.style.display = 'none';



	// VARIABLES //

	var thresh = 20; //Beneath this threshold points will snap to earlier points on a grid

	//Variables for devices currently in use
	var channel = new Channel(); //True when series of points being clicked for channel


	//If img src is set during mouse move, it interferes with mousedown
	var cursorMode = CursorModeEnum.SELECT.POINTER; //Enum tells you what CursorMode is in use at a time out of a limited set


	var rotateAngle = 0.0; //Angle that a CursorMode rotates in (only @ z axis for now)

	var collection = new Collection();

	var firstInChannel = false;

	var prevNodeIndex = 0; //Most recently used node

	var hel = false;

	var rectX1 = -1, rectY1 = -1, rectX2 = -1, rectY2 = -1;

	// PREVENT BOX ENTER FROM REFRESHING PAGE

	var commandControl = false;
	

	function keyPressHandler(e){
		console.log(e.keyCode);
		if (e.keyCode == 13) e.preventDefault(); //don't refresh page when enter in box

		//Control or command entered
		if (e.keyCode == 17 || e.keyCode == 91){
			//Control or command
			commandControl = true;
		}

		//Ctrl X
		if (e.keyCode == 88) {
			if (commandControl) cut_handler(e);
			commandControl = false;
		}

		//Ctrl V
		if (e.keyCode == 86){
			if (commandControl) paste_handler(e);
			commandControl = false;
		}

		if (e.keyCode == 67) {
			if (commandControl) copy_handler(e);
			commandControl = false;
		}
			
		//Press esc to revert to pointer mode
		if (e.keyCode == 27)	pointer_select_handler(e);

		//Press A to start and stop
		if (e.keyCode == 65)	channel_handler(e);

		//Press M to begin moving
		if (e.keyCode == 77)	move_handler(e);

		//Press delete to remove everything currently selected.
		if (e.keyCode == 8){
			console.log(collection);
			deleteListener(e);
			console.log(collection);
			firstInChannel = true; //not sure about this, should solve some problems
		}

		//Press right arrow to rotate right
		if (e.keyCode == 39) {
			rotateAngle += 3.0*Math.PI/180;
		}
		//Press left arrow to rotate left
		if (e.keyCode == 37) {
			rotateAngle -= 3.0*Math.PI/180;	
		}
		//Press H to go into helix mode
		if (e.keyCode == 72) {
			cursorMode = CursorModeEnum.PLACE.HELIX;
		}

		//Press S to save
		if (e.keyCode == 83) {
			console.log(JSON.stringify(collection)); //Save this to server somehow? 
			//I think if we store the files in JSON they should be pretty easy to parse,
			//save serverside as JSON, and then turn into our OpenSCAD custom format - 
			//the output files look like this
		}
		//Press L to load a JSON file
		if (e.keyCode == 76) {
			var test = "{\"channel\":{\"nodes\":[[75,42],[183,62],[68,161],[20,130],[148,261]],\"nodeColors\":[],\"edges\":[[1,3],[0,2],[1,3,4],[2,3,3,0],[2]]},\"helix_list\":[],\"t_list\":[],\"cross_list\":[]}";
			collection = JSON.parse(test);
		}
		redraw();
	}

	// MOUSE MOVE EVENT - MOVE IMAGE AROUND // 
	function mouseMoveHandler(e){
	//	console.log("moving mouse");
		//Track where the mouse is on the canvas
		mouseX = e.pageX - canvas.offsetLeft;
		mouseY = e.pageY - canvas.offsetTop;

		switch(cursorMode){

			case CursorModeEnum.SELECT.POINTER:
				pointerSelectHoverListener(e);
				break;

			case CursorModeEnum.SELECT.BOX:
				boxSelectMouseMoveListener(e);
				break;

			case CursorModeEnum.PLACE.RECT:
				rectClickMoveListener(e);
				break;

			case CursorModeEnum.OPERATE.MOVE:
				moveDragListeners(e);
				storeUndoState(); //push things to undo stack
				break;

			default:
				break;
		}
		redraw(); //draws canvas again

	}

	//KEY EVENT LISTENER TO START/END A DRAWING
	window.addEventListener("keydown", keyPressHandler, false); //Cannot add to canvas, must add to window

	//For some reason, mousedown needs to be on the window. Otherwise, it will interfere with mousemove in some odd way, and mousedown will never get called. 

	window.addEventListener("mousemove", mouseMoveHandler, false);

	// MOUSE DOWN EVENT //
	//Changed mousedown to "canvas" -> seems to give us all the functionality we need
	canvas.addEventListener('mousedown', function(e){
		
		switch(cursorMode) {

			//If the user is trying to place an object:
			case CursorModeEnum.PLACE.CHANNEL:		
				console.log("channel");
				channelClickListener(e);
				break;
			case CursorModeEnum.PLACE.HELIX:	
				console.log("helix");
				helixClickListener(e);
				break;
			case CursorModeEnum.PLACE.T_JUNCT:	
				tJunctClickListener(e);
				break;
			case CursorModeEnum.PLACE.CROSS_JUNCT:
				crossJunctClickListener(e);
				break;
			case CursorModeEnum.PLACE.VERTEX:
				console.log("vertex");
				collectionRegionClickListener(e);
				break;
			case CursorModeEnum.PLACE.PILLAR:
				console.log("pillar");
				pillarClickListener(e);
				break;
			case CursorModeEnum.PLACE.RECT:
				console.log("rect");
				rectClickDownListener(e);
				break;

			//If the user is trying to select an object:
			case CursorModeEnum.SELECT.POINTER:
				console.log("ptr");
				pointerSelectClickListener(e);
				break;
			case CursorModeEnum.SELECT.BOX:
				console.log("box");
				boxSelectMouseDownListener(e);
				break;

			//If the user is trying to operate on a collection
			case CursorModeEnum.OPERATE.MOVE:
				console.log("move");
				//TODO: Add listener to deal with translation
				moveMouseDownListener(e);
				break;

			default:
				console.log("Unknown Cursor Status: " + cursorMode)
				break;
		}
		redraw(); //draws canvas again
		storeUndoState(); //pushes changes to new stack

	});


	// MOUSE UP EVENT //
		
	canvas.addEventListener('mouseup', function(e){
		switch(cursorMode){
			case CursorModeEnum.OPERATE.MOVE:
				cursorMode = CursorModeEnum.SELECT.POINTER;
				anchorMouseY = -1;
				anchorMouseX = -1;
				break;

			case CursorModeEnum.PLACE.RECT:
				rectClickUpListener(e);

			case CursorModeEnum.SELECT.BOX:
				//cursorMode = CursorModeEnum.SELECT.POINTER;
				anchorMouseY2 = mouseY;
				anchorMouseX2 = mouseX;
				break;

			default:
				break;
		}		
	});

	// MOUSE LEAVE EVENT //
		
	canvas.addEventListener('mouseleave', function(e){		
	});

	// ADD VERTEX //

	function addVertex(x, y) {

		//Keep track of the radius that your node should have (1 typically, larger if collection region)		
		var rad = 1;
		if (cursorMode == CursorModeEnum.PLACE.VERTEX){
			rad = document.getElementById("collection_region_size_box").value;
		}

		//Keep track of the current node within threshold distance
		var currNodeIndex = collection.channel.nodes.indexOf(findNearestNode(x, y, rad));

		//If there isn't one, your currIndex is one more than curr # of nodes
		//And you should add a new node to your graph
		if(currNodeIndex == -1 || collection.channel.edges[prevNodeIndex] == null || collection.channel.edges[currNodeIndex] == null){
			currNodeIndex = collection.channel.nodes.length;
			collection.channel.nodes.push(new Node(x, y, rad)); //Adds node to graph
			collection.channel.edges.push([]); //Create empty list of edges to be filled by new node
		}

		//If you're not at the start of a new channel and the previous node was not deleted)
		//add an edge back to the previous node
		if (!firstInChannel){
				if (cursorMode == CursorModeEnum.PLACE.VERTEX) {
					collection.channel.nodes[currNodeIndex].r = rad;
				} else {
					
					if (cursorMode == CursorModeEnum.PLACE.CHANNEL) {

						var weight = parseInt(document.getElementById("channel_width_box").value);

						//Find the length of the channel
						var newChannelLength = collection.channel.distBetweenNodes(prevNodeIndex, currNodeIndex);

						console.log(newChannelLength);

						collection.channel.edges[prevNodeIndex].push(new Edge(prevNodeIndex, currNodeIndex, weight, 0)); //weight 1, type 0, default for now

						console.log("curr node index is");
						console.log(currNodeIndex);
						collection.channel.edges[currNodeIndex].push(new Edge(currNodeIndex, prevNodeIndex, weight, 0)); //doing directed for now with double edges 0 = channel
					} else if (cursorMode == CursorModeEnum.PLACE.HELIX) {
						var weight = parseInt(document.getElementById("mixer_width_box").value);
						var wavelength = parseInt(document.getElementById("mixer_wavelength_box").value);
						var amplitude = parseInt(document.getElementById("mixer_amplitude_box").value);
						collection.channel.edges[currNodeIndex].push(new Edge(currNodeIndex, prevNodeIndex, weight, 1, wavelength, amplitude)); //doing directed for now with double edges 1 = helix
					} 
				}
				
		}
		firstInChannel = false;	//Assume next time won't be the start of a new channel
		prevNodeIndex = currNodeIndex;	//Updates to most recently used node
	} 

</script>

